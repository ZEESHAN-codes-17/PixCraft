{% extends 'tools/base.html' %}

{% block title %}Format Converter - PixCraft{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="text-center mb-4">
            <h1 class="display-5"><i class="fas fa-exchange-alt"></i> Image Format Converter</h1>
            <p class="lead text-muted">Convert images between different formats instantly</p>
        </div>

        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-image"></i> Convert Image Format</h4>
            </div>

            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> <strong>Supported formats:</strong> PNG, JPG, WEBP, BMP, TIFF, GIF, ICO
                </div>

                <form id="imageFormatForm" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="conversion_type" value="image_format">
                    
                    <div class="mb-4">
                        <label for="imageInput" class="form-label fw-bold">Upload Image</label>
                        <input type="file" class="form-control form-control-lg" id="imageInput" name="image" accept="image/*" required>
                        <small class="text-muted">Select any image file (PNG, JPG, WEBP, BMP, etc.)</small>
                    </div>

                    <div class="mb-4">
                        <label for="outputFormat" class="form-label fw-bold">Convert To</label>
                        <select class="form-select form-select-lg" id="outputFormat" name="output_format" required>
                            <option value="PNG">PNG - Lossless, supports transparency</option>
                            <option value="JPG">JPG - Compressed, smaller file size</option>
                            <option value="WEBP">WEBP - Modern format, best compression</option>
                            <option value="BMP">BMP - Uncompressed, large files</option>
                            <option value="TIFF">TIFF - High quality, professional</option>
                            <option value="GIF">GIF - Supports animation</option>
                            <option value="ICO">ICO - Favicon/icon format</option>
                        </select>
                    </div>

                    <div id="imagePreview" class="mb-4 text-center" style="display: none;">
                        <p class="text-muted mb-2">Preview:</p>
                        <img id="imagePreviewImg" class="img-fluid rounded border shadow-sm" style="max-height: 400px;">
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        <i class="fas fa-sync-alt"></i> Convert Image
                    </button>
                </form>

                <!-- Loading Indicator -->
                <div id="loading" class="text-center mt-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <p class="mt-3 fw-bold">Converting your image...</p>
                </div>

                <!-- Error Alert -->
                <div id="error" class="alert alert-danger mt-4" style="display: none;"></div>

                <!-- Success Alert -->
                <div id="success" class="alert alert-success mt-4" style="display: none;"></div>
            </div>
        </div>

        <!-- Format Information Cards -->
        <div class="row mt-5 g-4">
            <div class="col-md-6">
                <div class="card h-100 border-primary">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-info-circle text-primary"></i> Why Convert Formats?</h5>
                        <ul class="mb-0">
                            <li>Reduce file size for faster loading</li>
                            <li>Convert to web-friendly formats</li>
                            <li>Add or remove transparency</li>
                            <li>Create favicons for websites</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100 border-success">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-star text-success"></i> Features</h5>
                        <ul class="mb-0">
                            <li><strong>Fast:</strong> Instant conversion</li>
                            <li><strong>Quality:</strong> High-quality output</li>
                            <li><strong>Privacy:</strong> No cloud storage</li>
                            <li><strong>Free:</strong> Unlimited conversions</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Format Guide -->
        <div class="card mt-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-book"></i> Format Guide</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>PNG:</strong> Best for logos, graphics with transparency</p>
                        <p><strong>JPG:</strong> Best for photos, smaller file size</p>
                        <p><strong>WEBP:</strong> Modern format, excellent compression</p>
                        <p><strong>GIF:</strong> Best for simple animations</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>BMP:</strong> Uncompressed Windows format</p>
                        <p><strong>TIFF:</strong> Professional photography format</p>
                        <p><strong>ICO:</strong> Website favicons (16x16, 32x32)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Image Preview
document.getElementById('imageInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('imagePreviewImg').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

// Form submission
document.getElementById('imageFormatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const success = document.getElementById('success');
    
    // Hide alerts
    error.style.display = 'none';
    success.style.display = 'none';
    
    // Show loading
    loading.style.display = 'block';
    
    // Disable submit button
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Converting...';
    
    fetch('{% url "tools:format_converter" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || 'Conversion failed');
            });
        }
        return response.blob();
    })
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        // Get filename
        const format = document.getElementById('outputFormat').value.toLowerCase();
        a.download = `converted.${format}`;
        
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
        
        loading.style.display = 'none';
        success.innerHTML = '<i class="fas fa-check-circle"></i> Conversion successful! Your file is downloading...';
        success.style.display = 'block';
        
        // Re-enable button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
        
        // Hide success message after 5 seconds
        setTimeout(() => {
            success.style.display = 'none';
        }, 5000);
    })
    .catch(error => {
        loading.style.display = 'none';
        error.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error: ' + error.message;
        error.style.display = 'block';
        
        // Re-enable button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
    });
});
</script>

<style>
.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-5px);
}

#imagePreview img {
    border: 3px solid #e9ecef;
}
</style>
{% endblock %}