{% extends 'tools/base.html' %}

{% block title %}Image to PDF - PixCraft{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">
                    <i class="fas fa-file-pdf"></i> Image to PDF Converter
                </h3>
            </div>
            <div class="card-body">
                <form id="pdfForm" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Image Size Selection -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-expand-arrows-alt"></i> PDF Page Size
                        </label>
                        <select class="form-select form-select-lg" id="pageSize" name="page_size">
                            <option value="a4">A4 (210mm × 297mm) - Standard</option>
                            <option value="letter">Letter (8.5" × 11") - US Standard</option>
                            <option value="fit-width">Fit to Width - Keep Aspect Ratio</option>
                            <option value="original">Original Size - No Resizing</option>
                        </select>
                        <small class="text-muted">Choose how images should fit in the PDF</small>
                    </div>

                    <!-- Drag & Drop Upload Area -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-images"></i> Upload Images (Multiple)
                        </label>
                        <div id="dropZone" class="border border-2 border-dashed rounded p-5 text-center bg-light">
                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                            <p class="mb-2">Drag & Drop images here</p>
                            <p class="text-muted small mb-3">or</p>
                            <input type="file" id="imageInput" name="images" accept="image/*" multiple class="d-none">
                            <button type="button" class="btn btn-primary" onclick="document.getElementById('imageInput').click()">
                                <i class="fas fa-folder-open"></i> Browse Files
                            </button>
                        </div>
                    </div>

                    <!-- Image Preview & Reorder Area -->
                    <div id="previewContainer" class="mb-4" style="display: none;">
                        <label class="form-label fw-bold">
                            <i class="fas fa-sort"></i> Images Preview (Drag to Reorder)
                        </label>
                        <div id="imageList" class="row g-3"></div>
                    </div>

                    <!-- Convert Button -->
                    <button type="submit" id="convertBtn" class="btn btn-success btn-lg w-100" disabled>
                        <i class="fas fa-file-pdf"></i> Convert to PDF
                    </button>
                </form>

                <!-- Loading -->
                <div id="loading" class="text-center mt-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Converting...</span>
                    </div>
                    <p class="mt-3 fw-bold">Creating your PDF...</p>
                </div>

                <!-- Error Alert -->
                <div id="error" class="alert alert-danger mt-4" style="display: none;"></div>
            </div>
        </div>

        <!-- Feature Info -->
        <div class="row mt-4 g-4">
            <div class="col-md-4">
                <div class="card h-100 border-primary">
                    <div class="card-body text-center">
                        <i class="fas fa-images fa-2x text-primary mb-3"></i>
                        <h6>Multiple Images</h6>
                        <p class="small text-muted mb-0">Upload multiple images at once</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-success">
                    <div class="card-body text-center">
                        <i class="fas fa-sync-alt fa-2x text-success mb-3"></i>
                        <h6>Rotate & Reorder</h6>
                        <p class="small text-muted mb-0">Rotate and drag to reorder images</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-warning">
                    <div class="card-body text-center">
                        <i class="fas fa-expand-arrows-alt fa-2x text-warning mb-3"></i>
                        <h6>Custom Sizes</h6>
                        <p class="small text-muted mb-0">Choose A4, Letter, or original size</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedFiles = [];
let rotations = {};

// CSRF Token Helper - MUST BE AT TOP!
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Drag & Drop
const dropZone = document.getElementById('dropZone');
const imageInput = document.getElementById('imageInput');

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-primary', 'bg-primary', 'bg-opacity-10');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('border-primary', 'bg-primary', 'bg-opacity-10');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-primary', 'bg-primary', 'bg-opacity-10');
    handleFiles(e.dataTransfer.files);
});

imageInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
});

function handleFiles(files) {
    // ADD new files instead of replacing
    const newFiles = Array.from(files);
    
    newFiles.forEach(file => {
        selectedFiles.push(file);
    });
    
    displayImages();
    document.getElementById('convertBtn').disabled = false;
}

function displayImages() {
    const container = document.getElementById('imageList');
    const previewContainer = document.getElementById('previewContainer');
    
    container.innerHTML = '';
    
    selectedFiles.forEach((file, index) => {
        const col = document.createElement('div');
        col.className = 'col-6 col-md-3';
        col.draggable = true;
        col.dataset.index = index;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            col.innerHTML = `
                <div class="card h-100">
                    <img src="${e.target.result}" class="card-img-top" style="height: 150px; object-fit: cover; transform: rotate(${rotations[index] || 0}deg);">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">#${index + 1}</small>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary" onclick="rotateImage(${index})" title="Rotate">
                                    <i class="fas fa-redo"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="removeImage(${index})" title="Remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };
        reader.readAsDataURL(file);
        
        // Drag events for reordering
        col.addEventListener('dragstart', handleDragStart);
        col.addEventListener('dragover', handleDragOver);
        col.addEventListener('drop', handleDrop);
        
        container.appendChild(col);
    });
    
    previewContainer.style.display = 'block';
}

function rotateImage(index) {
    rotations[index] = (rotations[index] || 0) + 90;
    if (rotations[index] >= 360) rotations[index] = 0;
    displayImages();
}

function removeImage(index) {
    selectedFiles.splice(index, 1);
    delete rotations[index];
    
    // Reindex rotations
    const newRotations = {};
    Object.keys(rotations).forEach(key => {
        const oldIndex = parseInt(key);
        if (oldIndex > index) {
            newRotations[oldIndex - 1] = rotations[key];
        } else if (oldIndex < index) {
            newRotations[oldIndex] = rotations[key];
        }
    });
    rotations = newRotations;
    
    if (selectedFiles.length === 0) {
        document.getElementById('previewContainer').style.display = 'none';
        document.getElementById('convertBtn').disabled = true;
    }
    
    displayImages();
}

// Drag and drop reordering
let draggedElement = null;

function handleDragStart(e) {
    draggedElement = this;
    e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e) {
    if (e.preventDefault) e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDrop(e) {
    if (e.stopPropagation) e.stopPropagation();
    
    if (draggedElement !== this) {
        const fromIndex = parseInt(draggedElement.dataset.index);
        const toIndex = parseInt(this.dataset.index);
        
        // Swap files
        [selectedFiles[fromIndex], selectedFiles[toIndex]] = [selectedFiles[toIndex], selectedFiles[fromIndex]];
        
        // Swap rotations
        [rotations[fromIndex], rotations[toIndex]] = [rotations[toIndex] || 0, rotations[fromIndex] || 0];
        
        displayImages();
    }
    
    return false;
}

// Form submission
document.getElementById('pdfForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const pageSize = document.getElementById('pageSize').value;
    
    formData.append('page_size', pageSize);
    
    selectedFiles.forEach((file, index) => {
        formData.append('images', file);
        formData.append(`rotate_${index}`, rotations[index] || 0);
    });
    
    // Show loading
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').style.display = 'none';
    document.getElementById('convertBtn').disabled = true;
    
    // Get CSRF token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('{% url "tools:image_to_pdf" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || 'Conversion failed');
            });
        }
        return response.blob();
    })
    .then(blob => {
        // Create download
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'converted.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        // Reset
        document.getElementById('loading').style.display = 'none';
        document.getElementById('convertBtn').disabled = false;
    })
    .catch(error => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').textContent = error.message;
        document.getElementById('error').style.display = 'block';
        document.getElementById('convertBtn').disabled = false;
    });
});
</script>

<style>
#dropZone {
    transition: all 0.3s ease;
    cursor: pointer;
}

#dropZone:hover {
    border-color: #0d6efd !important;
}

[draggable="true"] {
    cursor: move;
}
</style>
{% endblock %}